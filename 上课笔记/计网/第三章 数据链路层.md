## 数据链路

### 总览

###### 协议定义了数据交换格式(数据结构 frame) & 链路两端的行为

- 数据链路：物理线路 + <u>通信协议</u> （由适配器 即网卡实现）
- 传送单元：`帧`
- node +++link+++ node
- node : host or router
- link : channel conncet the nodes
- 链路层中 'procedure' = 'protocol'   （因为早期称为**通信规程**）
- 不是所有网络存在第三层及以上（蓝牙）

##### 主要任务

- 错误检测 Error notification
- 网络拓扑 Network topology
- 流控制 Flow control

##### 三个基本问题

1. 封装成帧
   - 一个帧的长度：数据部分 + 帧首部 + 帧尾部
   - 最大传送单元`MTU`(Maximum Transfer Unit)
2. 透明传输
   - 透明：所有的数据都可以传送出去
   - 当传送的数据包含了传输结束符`EOT`,需要在它前面加上转义符`ESC`(`0x1B`) ，这种策略叫做字节 / 字符填充
3. 差错检测
   - 数据链路层<u>不提供</u><u>可靠传输</u>
   - 传输差错
     - 比特差错 , 通过CRC循环冗余校验解决
     - 帧丢失 ， 帧重复 ， 帧失序

##### 与第一层的不同（*）

- 第一层无法与上层沟通，第二层存在  逻辑链路控制
- 第一层无法指定host名称，第二层存在MAC(media access control)地址，用于指定下一跳物理地址
- 第二层可以对传输命名
- 第二层使用frame帧数据帧来进行数据传输

### Service协商

##### 类别：（*）

1. Connectionless with `nonAck`

   例：

   - 上层传输 `IP`协议 (异步)
   - 实时任务
   - 局域网

2. Connectionless with `ack`

   例：无线网络

3. Connection with `ack`

##### 面向连接&无连接网络服务：

- 面向网络服务
  - 连接建立
  - 数据传输
  - 连接终止
  - ps: 必须在相同的静态路径上传输。
  - 用于音频、视频应用

- 无连接网络服务
  - 不需要打包排队、数据吞吐
  - 每个封装包必须完全编址
  - 动态路径选择、动态带宽分配
  - 数据失效时可以重新选择路径
  - 对传输可以延迟or 重新排队的数据有用，用于基于数据的应用

1. connectionless : 无连接网络，实体间不需要事先建立连接

   - 数据报：不要求接收端应答
     - 用于可靠链路
   - 确认交付 : 可靠数据报，需要对**报文分组**返回应答报文ack
   - 请求回答 : 要求接收端用户每接收一个**报文**均需要返回一个应答报文

   connection : 

2. ack :

   NoAck :

------



### 拓扑分类

#### Ethernet

- 逻辑上总线 ，物理上星形 or 扩展星形
- 先到先服务

#### Token ring

- 逻辑上环 ， 物理上星形
- 轮流

#### FDDI

- 逻辑上环， 物理上 dual ring
- 轮流

------



### 以太网和CSMA/CD 协议

CSMA / CD : 载波侦听多路访问 / 冲突检测

#### 解释

1. 载波侦听：时刻监测总线信号

2. 多点接入：由于是总线型，多个计算机连接在一条总线上

3. 碰撞检测：边发送边监听

   因为一个站点无法同时接受、发送，所以CSMA / CD 协议用于半双工通信

#### 占用策略

1. Deterministic 

   轮流占用

   使用token轮流，持有token则可以进行传输frame

2. Non-deterministic

   先到先得

   ###### 协议：CSMA/CD 载波侦听多路访问／冲突检测(Carrier Scene Multiple Access with Collision Detection)  

   ​	以太网利用这个协议来进行传输仲裁(冲突检测)

   1. 监听当前信道上是否有数据再发送，如果信道空闲，直接发送数据，如果信道忙，则按照一定的退避算法进行延时监听。 
   2. 信道允许发送数据，发送数据
   3. 发送数据的同时进行监听，若检测到冲突就阻塞信息，强化冲突，转入**1**

#### LAN 传输方式

1. unicast 单播

    报文发送给一个目的

2. multicast 多播

   发送给所有nodes的子集

3. broadcast 广播

   发送给全部nodes ， 地址全1 **(`0xffffff`)**

   会让站点的工作中断

   ——最好用于

   - 目的MAC地址未知
   - 目的均为主机`host`

#### LAN标准

- 规定数据传输的交互
- 传输方式

#### 局域网中的数据链路层

##### 数据链路层进一步分层

标准制定 ： IEEE 802.2

- ##### `MAC media access control`

  - 媒体接入控制
  - 向下传输给媒体
  - 定义物理层如何传输帧

- ##### `LLC  logical link control` 

  - 逻辑链路控制
  - 向上传输给网络层

##### 适配器

1. 网络接口卡 `NIC` (Network Interface Card) , 网卡
2. 进行串行、并行传输转换
3. 计算机硬件地址，存在于适配器的`ROM`中

#### 以太网特点

1. **无连接**的工作方式

   高层协议对是否重传来进行判断，对于以太网来说，都是新传帧

2. 采用**曼彻斯特编码**，实现位同步

#### 以太网MAC层

##### MAC层硬件地址

`48bit , 6 byte`

- 最左边的 3 个字节为**组织唯一标识符OUI**  (Organizational Unique Identifier)
- 后三个字节为**扩展标识符**(extended identifier)

##### 封装成帧

- 帧是链路层的传输单元
- 帧frame含有的小模块fields
  - frame start field
  - address field
  - length / type / control field
  - data field
  - frame check sequence field
  - frame stop field

##### MAC帧格式(*)

###### 基于IEEE / 802.3标准

- Preamble 前导: 8Bytes
  - 预先告知有一个帧开始
  - 7 帧起始定界符*（10101010） + 1 同步 （10101011）
- Dest : 6byte
  - 目的MAC地址，48位
- Source : 6 byte
  - 源地址 48位
- len : 2bytes
  - 802.3 使用长度字段 0x abcd, 表示data数据的长度
  - 如果len的值大于1500 ，那么指示<u>类型</u>(Ethernet标准)
  - 但Ethernet 帧使用<u>类型字段</u>来识别网络层协议
- data ：数据  46-1500 bytes 
  - 包含 <u>网络层</u>到数据链路层的数据包
  - 如果长度小于46字节，那么假如填充字段。将会在IP协议时被去除
- FCS :  4 bytes
  - 帧校验序列 (FracIue check sequence )
  - 存放循环冗余校验
- PS：以太帧的长度定义为：**源地址到冗余码**,以上就是 `64 - 1518` bytes

#### 以太网LLC层

逻辑链路控制层

##### 特性

- 同一个链路上不同设备的通信
- 支持无连接和**面向连接**服务
- 一个LLC子层可以适配不同的MAC子层

##### 包装

Encapsulation

- 得到网络层的packet数据，添加更多的信息来让它到达目的地
- 添加目的服务站点 (DSAP  Destination Service Access Point)  和 源服务站点 (SSAP Source Service Access Point)
- 传入MAC子层来进行更多的包装

#### 以太网传输策略

边传输边监听，及时处理冲突

- 所有的站点均可看到帧

- MAC地址决定了目的地 ；仅有对应的站点会上至网络层，其他均丢弃帧

- 步骤

  1. 监听传输

  2. 强化碰撞(Broadcast jam signal)

     当冲突发生，就广播冲突信号

### 无线局域网 Wireless LAN

#### WLAN

- 通过cell单元交互
- 信号只能被相邻站点接收
- 短距离通讯

#### IEEE 802.11

- 无线以太网标准
- 采用星型拓扑

#### 架构模式

- **基本服务集BSS** -- Basic Service Set
  - 一个**基站** BS -- Base Station
  - 若干个移动站
  - 一个BBS覆盖的地理范围叫做**基本服务区**(basic service area)
- **访问点 AP** -- Access Point
  - 作为一个基站
  - 不同的AP之间使用**有线传输**
  - 是一个无线网络中的特殊节点，通过这个节点，无线网络中的其它类型节点可以和无线网络外部以及内部进行通信
  - 当AP被安装，服务集标识符 SSID (Service Set Identifier)_用来标识一个无线网络 ]  和通道 channel 会被指定

#### 访问流程 

移动端与AP建立关联的方式

##### 主动式扫描

- 移动站主动发出**探测请求帧(probe request frame)** , 然后等待接入点返回的**探测响应帧(probe response frame)**

##### 被动式扫描

- 移动站等待接收接入点AP周期性发出的**信标帧(beacon frame)**

#### 802.11的帧

##### 类别

1. 控制帧
2. 管理帧 Management frames
3. 数据帧

##### 数据帧格式

1. MAC首部，30 bytes
2. 帧主体(数据部分)
3. 帧检验序列 FCS  , 4 bytes

###### 数据帧字段说明

| 名称                    | 描述                                                         | 长度 Byte |
| ----------------------- | ------------------------------------------------------------ | --------- |
| 帧控制                  |                                                              | 2         |
| 持续时间                | 用来记载网络分配矢量（Network Allocation Vector，简称`NAV`） | 2         |
| 目的地址                | 最后的接收端，即负责将帧交付上层协议处理的工作站             | 6         |
| 源地址                  | 传送的来源                                                   | 6         |
| 接收端地址              | 负责处理该帧的无线工作站                                     | 6         |
| 顺序控制字段（Seq-Ctl） | 用来重组帧片段以及丢弃重复帧                                 | 2         |
| 发送端地址              | 将帧传送至无线媒介的无线接口                                 | 6         |
| 帧校验序列（FCS）       | 让工作站能够检查所受到的帧的完整性                           | 4         |

##### 四个地址字段

| 去往AP | 来自AP | 地址1    | 地址2  | 地址3    | 地址4 |
| ------ | ------ | -------- | ------ | -------- | ----- |
| 0      | 1      | 目的地址 | AP地址 | 源地址   | ——    |
| 1      | 0      | AP地址   | 源地址 | 目的地址 | ——    |

- 去往AP为1时，表示 `移动端` 发往 `AP`
- 来自AP为1时，表示 `AP` 发往 `移动端`

### CDMA / CA

冲突避免

#### 机制

##### 以太网

- 信号传输给所有站点，包括冲突
- 一个时刻，信道上只能有一个帧传输

##### WLAN

- 信号传输给相邻站点
- 同一时刻允许多个帧传输

#### 不用CDMA / CD的原因

1. 碰撞检测要求不间断监听信道；无线信道的信号强度动态性大

2. **隐蔽站问题：**

   A , B , C 中， A , C都向B 传输数据；但是A C 彼此太远无法监听

3. **暴露站问题：**

   B 向 A 发送数据 ， C 可以监听到B信道忙， 导致C不敢向D发送数据